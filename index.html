<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>Unity Web Player | horseGame URP</title>
  <link rel="shortcut icon" href="TemplateData/favicon.ico" />
  <link rel="stylesheet" href="TemplateData/style.css" />

  <!-- Key: include viewport-fit and height=device-height -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, height=device-height" />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #0b0b0b;
      overscroll-behavior: none;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
      touch-action: none;
    }
    /* Safe-area wrapper */
    .safe {
      position: fixed;
      inset: 0;
      padding-top: env(safe-area-inset-top);
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      display: grid;
      place-items: center;

      /* Use the largest stable viewport height if available */
      height: 100lvh;          /* iOS 16+/modern */
      min-height: 100svh;      /* when toolbars visible */
      /* JS fallback below sets --vh; this line makes it take precedence if set */
      height: calc(var(--vh, 1lvh) * 100);
    }

    #unity-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: grid;
      place-items: center;
      overflow: hidden;
    }

    #unity-canvas {
      display: block;
      background: #000;
      /* Prevent template CSS from shrinking it—JS sets explicit px size */
      width: 100% !important;
      height: auto !important;
      max-width: 100%;
      max-height: 100%;
    }

    #unity-loading-bar {
      position: absolute;
      bottom: calc(12px + env(safe-area-inset-bottom));
      left: 50%;
      transform: translateX(-50%);
      width: min(360px, 80vw);
      height: 8px;
      background: rgba(255,255,255,0.15);
      border-radius: 8px;
      overflow: hidden;
      display: none;
    }
    #unity-progress-bar-empty { display: none; }
    #unity-progress-bar-full {
      width: 0%;
      height: 100%;
      background: #fff;
      transition: width .2s ease;
    }

    #unity-footer {
      position: absolute;
      left: 0; right: 0;
      bottom: env(safe-area-inset-bottom);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    #unity-warning { color: #fff; text-align: center; }
  </style>
</head>
<body>
  <div class="safe">
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas" tabindex="-1"></canvas>

      <div id="unity-loading-bar">
        <div id="unity-progress-bar-full"></div>
      </div>

      <div id="unity-warning"></div>

      <div id="unity-footer">
        <div id="unity-logo-title-footer"></div>
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">horseGame URP</div>
      </div>
    </div>
  </div>

  <script>
    const canvas = document.querySelector("#unity-canvas");
    const safeRoot = document.querySelector(".safe");

    /* ---------- iOS initial-height fallback ---------- */
    function setVHVar() {
      // Prefer the biggest reliable height: physical screen / DPR
      const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 4));
      const screenH = (window.screen && window.screen.height) ? window.screen.height : window.innerHeight;
      const logicalScreenH = screenH / dpr;
      const best = Math.max(logicalScreenH, window.innerHeight, (window.visualViewport ? window.visualViewport.height : 0));
      document.documentElement.style.setProperty('--vh', (best * 0.01) + 'px');
    }
    setVHVar();

    function unityShowBanner(msg, type) {
      const warningBanner = document.querySelector("#unity-warning");
      function updateBannerVisibility() { warningBanner.style.display = warningBanner.children.length ? 'block' : 'none'; }
      const div = document.createElement('div');
      div.innerHTML = msg;
      div.style = 'padding: 10px; margin: 6px auto; max-width: 90vw; border-radius: 6px;';
      if (type === 'error') div.style.background = 'rgba(255,0,0,.85)';
      else {
        if (type === 'warning') div.style.background = 'rgba(255,255,0,.85)';
        setTimeout(() => { warningBanner.removeChild(div); updateBannerVisibility(); }, 5000);
      }
      warningBanner.appendChild(div);
      updateBannerVisibility();
    }

    const buildUrl = "Build";
    const loaderUrl = buildUrl + "/BuildWebGLv4.0.loader.js";
    const config = {
      arguments: [],
      dataUrl: buildUrl + "/BuildWebGLv4.0.data.unityweb",
      frameworkUrl: buildUrl + "/BuildWebGLv4.0.framework.js.unityweb",
      codeUrl: buildUrl + "/BuildWebGLv4.0.wasm.unityweb",
      streamingAssetsUrl: "StreamingAssets",
      companyName: "DefaultCompany",
      productName: "horseGame URP",
      productVersion: "0.1.0",
      showBanner: unityShowBanner,
      // Keep Unity in sync with our canvas size
      // (you can set to false if you fully control buffer sizes yourself)
      // matchWebGLToCanvasSize: true,
    };

    /* ---------- Responsive sizing ---------- */
    const ASPECT = 9 / 16;   // portrait
    const MAX_DPR = 1.75;

    function getViewportWH() {
      const dpr = Math.min(window.devicePixelRatio || 1, 4);
      const vv = window.visualViewport;
      let w = vv ? vv.width : window.innerWidth;
      let h = vv ? vv.height : window.innerHeight;

      // If initial h is tiny, fall back to physical screen height
      const screenHLogical = (window.screen && window.screen.height) ? (window.screen.height / dpr) : h;
      if (h < screenHLogical * 0.8) {
        h = screenHLogical;
      }
      return { w, h };
    }

    function sizeCanvas() {
      const { w, h } = getViewportWH();
      let cssW, cssH;
      if (w / h > ASPECT) { cssH = h; cssW = h * ASPECT; }
      else { cssW = w; cssH = w / ASPECT; }

      // CSS pixels (display size)
      canvas.style.width = cssW + "px";
      canvas.style.height = cssH + "px";

      // Render buffer size
      const dpr = Math.min(window.devicePixelRatio || 1, MAX_DPR);
      canvas.width  = Math.round(cssW * dpr);
      canvas.height = Math.round(cssH * dpr);
    }

    // Stabilize around first paint & after orientation
    function stabilize(ms = 1000) {
      const start = performance.now();
      function tick(now) {
        setVHVar();
        sizeCanvas();
        if (now - start < ms) requestAnimationFrame(tick);
      }
      sizeCanvas();
      requestAnimationFrame(tick);
      setTimeout(sizeCanvas, 120);
      setTimeout(sizeCanvas, 360);
      setTimeout(sizeCanvas, 720);
    }

    // Boot sizing
    stabilize();

    // Events
    let raf;
    function qResize(){ cancelAnimationFrame(raf); raf = requestAnimationFrame(() => { setVHVar(); sizeCanvas(); }); }
    window.addEventListener('resize', qResize);
    window.addEventListener('orientationchange', () => setTimeout(() => stabilize(1200), 120));
    window.addEventListener('pageshow', () => stabilize(800));
    document.addEventListener('visibilitychange', () => { if (!document.hidden) stabilize(800); });
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', qResize);
      window.visualViewport.addEventListener('scroll', qResize);
    }

    // Mobile config
    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
      document.querySelector("#unity-container").className = "unity-mobile";
      canvas.className = "unity-mobile";
      config.devicePixelRatio = Math.min(window.devicePixelRatio || 1, MAX_DPR);
    } else {
      canvas.style.width = "1080px";
      canvas.style.height = "1920px";
    }

    document.querySelector("#unity-loading-bar").style.display = "block";

    // Load Unity
    const script = document.createElement("script");
    script.src = loaderUrl;
    script.onload = () => {
      createUnityInstance(canvas, config, (progress) => {
        document.querySelector("#unity-progress-bar-full").style.width = (progress * 100).toFixed(0) + "%";
      }).then((unityInstance) => {
        document.querySelector("#unity-loading-bar").style.display = "none";

        // In case Unity or template modifies canvas styles, enforce sizing briefly
        stabilize(1200);

        document.querySelector("#unity-fullscreen-button").onclick = () => unityInstance.SetFullscreen(1);
      }).catch((message) => {
        alert(message);
      });
    };
    document.body.appendChild(script);
  </script>
</body>
</html>
