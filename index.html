<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Unity Web Player | horseGame URP</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico" />
    <link rel="stylesheet" href="TemplateData/style.css" />

    <!-- Responsive + safe-area -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, height=device-height" />

    <style>
      html, body {
        height: 100%;
        margin: 0;
        background: #0b0b0b;
        overscroll-behavior: none;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
        touch-action: none;
      }

      /* Wrap everything to respect iPhone notches/home bar */
      .safe {
        position: fixed;
        inset: 0;
        padding-top: env(safe-area-inset-top);
        padding-right: env(safe-area-inset-right);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
        display: grid;
        place-items: center;

        /* --- FIX 1: Make initial height correct on iOS (URL bar issue) --- */
        height: 100dvh; /* modern iOS/Chrome */
      }

      #unity-container {
        position: relative;
        width: 100%;
        height: 100%;
        display: grid;
        place-items: center;
        overflow: hidden;
      }

      #unity-canvas {
        display: block;
        width: 100%;
        height: auto;
        max-width: 100%;
        max-height: 100%;
        background: #000;
      }

      #unity-loading-bar {
        position: absolute;
        bottom: calc(12px + env(safe-area-inset-bottom));
        left: 50%;
        transform: translateX(-50%);
        width: min(360px, 80vw);
        height: 8px;
        background: rgba(255,255,255,0.15);
        border-radius: 8px;
        overflow: hidden;
      }
      #unity-progress-bar-empty { display: none; }
      #unity-progress-bar-full {
        width: 0%;
        height: 100%;
        background: #fff;
        transition: width .2s ease;
      }

      #unity-footer {
        position: absolute;
        left: 0; right: 0;
        bottom: env(safe-area-inset-bottom);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        pointer-events: auto;
      }

      #unity-warning { color: #fff; text-align: center; }
    </style>
  </head>
  <body>
    <div class="safe">
      <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas" tabindex="-1"></canvas>

        <div id="unity-loading-bar">
          <div id="unity-progress-bar-full"></div>
        </div>

        <div id="unity-warning"></div>

        <div id="unity-footer">
          <div id="unity-logo-title-footer"></div>
          <div id="unity-fullscreen-button"></div>
          <div id="unity-build-title">horseGame URP</div>
        </div>
      </div>
    </div>

    <script>
      const canvas = document.querySelector("#unity-canvas");

      function unityShowBanner(msg, type) {
        const warningBanner = document.querySelector("#unity-warning");
        function updateBannerVisibility() {
          warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
        }
        const div = document.createElement('div');
        div.innerHTML = msg;
        div.style = 'padding: 10px; margin: 6px auto; max-width: 90vw; border-radius: 6px;';
        if (type === 'error') div.style.background = 'rgba(255,0,0,.85)';
        else {
          if (type === 'warning') div.style.background = 'rgba(255,255,0,.85)';
          setTimeout(() => { warningBanner.removeChild(div); updateBannerVisibility(); }, 5000);
        }
        warningBanner.appendChild(div);
        updateBannerVisibility();
      }

      const buildUrl = "Build";
      const loaderUrl = buildUrl + "/BuildWebGLv4.0.loader.js";
      const config = {
        arguments: [],
        dataUrl: buildUrl + "/BuildWebGLv4.0.data.unityweb",
        frameworkUrl: buildUrl + "/BuildWebGLv4.0.framework.js.unityweb",
        codeUrl: buildUrl + "/BuildWebGLv4.0.wasm.unityweb",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "horseGame URP",
        productVersion: "0.1.0",
        showBanner: unityShowBanner
      };

      // ---------- RESPONSIVE SCALING ----------
      const ASPECT = 9 / 16;   // portrait 1080x1920
      const MAX_DPR = 1.75;

      function viewportSize() {
        const vv = window.visualViewport;
        return {
          w: vv ? vv.width  : window.innerWidth,
          h: vv ? vv.height : window.innerHeight
        };
      }

      function resizeCanvas() {
        const { w, h } = viewportSize();

        // Fit inside screen while preserving aspect (letterbox)
        let cssW, cssH;
        if (w / h > ASPECT) {
          cssH = h;
          cssW = h * ASPECT;
        } else {
          cssW = w;
          cssH = w / ASPECT;
        }

        canvas.style.width  = cssW + "px";
        canvas.style.height = cssH + "px";

        const dpr = Math.min(window.devicePixelRatio || 1, MAX_DPR);
        canvas.width  = Math.round(cssW * dpr);
        canvas.height = Math.round(cssH * dpr);
      }

      // --- FIX 2: run a stabilization loop at boot & after orientation
      function stabilizeResize(durationMs = 600, stepMs = 100) {
        const start = performance.now();
        function tick(now) {
          resizeCanvas();
          if (now - start < durationMs) requestAnimationFrame(tick);
        }
        // first immediate pass then a few frames while Safari settles
        resizeCanvas();
        requestAnimationFrame(tick);
        setTimeout(resizeCanvas, stepMs);       // extra nudge
        setTimeout(resizeCanvas, stepMs * 3);   // extra nudge
      }

      // Initial sizing
      stabilizeResize();

      let raf;
      function queueResize() { cancelAnimationFrame(raf); raf = requestAnimationFrame(resizeCanvas); }
      window.addEventListener('resize', queueResize);
      window.addEventListener('orientationchange', () => {
        // give iOS a moment to recalc viewport, then stabilize
        setTimeout(() => stabilizeResize(), 120);
      });
      window.addEventListener('pageshow', () => stabilizeResize());
      document.addEventListener('visibilitychange', () => { if (!document.hidden) stabilizeResize(); });
      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', queueResize);
        window.visualViewport.addEventListener('scroll', queueResize);
      }

      // Mobile tweaks
      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        document.querySelector("#unity-container").className = "unity-mobile";
        canvas.className = "unity-mobile";
        config.devicePixelRatio = Math.min(window.devicePixelRatio || 1, MAX_DPR);
      } else {
        // Desktop fallback windowed size (optional)
        canvas.style.width = "1080px";
        canvas.style.height = "1920px";
      }

      document.querySelector("#unity-loading-bar").style.display = "block";

      // ---------- LOAD UNITY ----------
      const script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          document.querySelector("#unity-progress-bar-full").style.width = (progress * 100).toFixed(0) + "%";
        }).then((unityInstance) => {
          document.querySelector("#unity-loading-bar").style.display = "none";
          document.querySelector("#unity-fullscreen-button").onclick = () => unityInstance.SetFullscreen(1);
          stabilizeResize(); // ensure final size after Unity touches canvas
        }).catch((message) => {
          alert(message);
        });
      };
      document.body.appendChild(script);
    </script>
  </body>
</html>
